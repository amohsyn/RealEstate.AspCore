<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>IndexedDB Example</title>
</head>
<body>
    <h1>IndexedDB Example</h1>

    <p>
        <fieldset id="addForm">
            <legend>Add Contact</legend>
            <label>Name</label>
            <input id="nameInput">
            <label>Email</label>
            <input id="emailInput">
            <button id="addButton">Add</button>
        </fieldset>
    </p>

    <table id="contacts">
        <thead>
            <tr><th>Name</th><th>Email</th></tr>
        </thead>
        <tbody></tbody>
    </table>

    <p>
        <button id="deleteButton">Delete</button>
    </p>

    <script>
        // Helpers for working with indexedDB API.
        var indexedDB = window.indexedDB ||
            window.webkitIndexedDB ||
            window.mozIndexedDB;
        function Db(name) {
            this.init = function (version, upgrade, done) {
                console.log('init');
                const openReq = indexedDB.open(name, version);
                openReq.onsuccess = function (e) {
                    const db = e.target.result;
                    // Chrome 23 still has setVersion so don't upgrade
                    // unless the version is still old.
                    if ('setVersion' in db && db.version < version) {
                        const setVerReq = db.setVersion(version);
                        setVerReq.onsuccess = function (e) {
                            console.log('upgrading');
                            upgrade(e.target.result.db);
                            done();
                        };
                    } else {
                        done();
                    }
                };
                openReq.onupgradeneeded = function (e) {
                    // Never gets raised before Chrome 23.
                    console.log('upgrading');
                    upgrade(e.target.result);
                };
                openReq.onerror = function (e) {
                    console.log('init error');
                };
                openReq.onblocked = function (e) {
                    console.log('init blocked');
                };
            };
            this.read = function (stores, fn, done) {
                return this.transaction('readonly', stores, fn, done);
            };
            this.readWrite = function (stores, fn, done) {
                return this.transaction('readwrite', stores, fn, done);
            };
            this.transaction = function (mode, stores, fn, done) {
                const openReq = indexedDB.open(name);
                openReq.onsuccess = function (e) {
                    const db = e.target.result;
                    const tx = db.transaction(stores, mode);
                    tx.oncomplete = function (e) {
                        if (done) {
                            done();
                        }
                    };
                    tx.onabort = function (e) {
                        console.log('tx abort');
                    };
                    tx.onerror = function (e) {
                        console.log('tx error');
                    };
                    fn(tx);
                };
                openReq.onerror = function (e) {
                    console.log('open tx error');
                };
            };
        }
        Db.deleteDatabase = function (name, done) {
            const delReq = indexedDB.deleteDatabase(name);
            delReq.onsuccess = function (e) {
                // Not triggered before Chrome 23.
                done();
            };
            delReq.onerror = function (e) {
                console.log('delete error');
            };
            delReq.onblocked = function (e) {
                console.log('delete blocked');
            };
        };
    </script>
    <script>
        // The actual script for this page.
        var databaseName = 'ContactsDB';
        var contactsStoreName = 'contacts';
        var contactsDB = new Db(databaseName);
        var contacts = document.getElementById('contacts');
        contactsDB.init(1, function (db) {
            db.createObjectStore(contactsStoreName, {
                autoIncrement: true
            });
        }, function () {
            console.log('ready');
            loadContactsTable();
        });
        function loadContactsTable() {
            contactsDB.read([contactsStoreName], function (tx) {
                const cursor = tx.objectStore(contactsStoreName).openCursor();
                cursor.onsuccess = function (e) {
                    if (e.target.result) {
                        addContactToTable(e.target.result.value);
                        e.target.result.continue();
                    }
                };
                cursor.onerror = function (e) {
                    console.log('cursor error');
                };
            });
        }
        function addContactToTable(contact) {
            const newRow = contacts.insertRow(-1);
            const nameCell = newRow.insertCell(-1);
            nameCell.textContent = contact.name;
            const emailCell = newRow.insertCell(-1);
            emailCell.textContent = contact.email;
        }
        var nameInput = document.getElementById('nameInput');
        var emailInput = document.getElementById('emailInput');
        document.getElementById('addButton').onclick = function (e) {
            e.preventDefault();
            var name = nameInput.value;
            var email = emailInput.value;
            console.log('adding');
            contactsDB.readWrite([contactsStoreName], function (tx) {
                const contact = {
                    name: name,
                    email: email
                };
                tx.objectStore(contactsStoreName).put(contact);
                addContactToTable(contact);
            }, function () {
                console.log('added');
                nameInput.value = '';
                emailInput.value = '';
                nameInput.focus();
            });
        };
       
    </script>
</body>
</html>